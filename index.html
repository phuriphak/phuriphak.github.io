<button id="generate-link">üì® ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>
<p id="invite-link"></p>
<div id="qrcode"></div>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.1/+esm";

    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase
    const supabaseUrl = "https://qddlkalznhlyuhpxlxxc.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkZGxrYWx6bmhseXVocHhseHhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA4ODU3NjksImV4cCI6MjA1NjQ2MTc2OX0.MN7POFGN967nOr616tRI5l3Z1kXSsXOY5HwegUfZ7eE";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF
    const liffId = "2006986037-JozP7wKE";

    document.getElementById("generate-link").addEventListener("click", async () => {
        const liff = await import("https://static.line-scdn.net/liff/edge/2/sdk.js");
        await liff.default.init({ liffId });

        if (!liff.default.isLoggedIn()) {
            liff.default.login();
            return;
        }

        const profile = await liff.default.getProfile();
        const userId = profile.userId;

        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Referral Code
        const referralCode = generateReferralCode();

        // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Supabase
        await supabase.from("referrals").insert([{ user_id: userId, referral_code: referralCode }]);

        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á LIFF URL + Referral Code
        const inviteLink = `https://liff.line.me/${liffId}?ref=${referralCode}`;
        document.getElementById("invite-link").innerText = inviteLink;

        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code
        document.getElementById("qrcode").innerHTML = "";
        QRCode.toCanvas(inviteLink, { width: 200 }, (err, canvas) => {
            if (!err) document.getElementById("qrcode").appendChild(canvas);
        });
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Referral Code
    function generateReferralCode() {
        return Math.random().toString(36).substr(2, 8).toUpperCase();
    }
</script>
